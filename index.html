<html>
  <head>
    <meta charset="utf-8" />
    <title>Native QR Code reader demo</title>
    <style>
      #json-response {
        width: 100%;
        max-width: 500px;
        min-height: 200px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-family: monospace;
        white-space: pre-wrap;
        margin-top: 20px;
        background-color: #f5f5f5;
      }
    </style>
  </head>
  <body>
    <video autoplay></video>
    <p>
      <label
        >camera:
        <select id="device-list"></select>
      </label>
    </p>
    <div id="json-response"></div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      const video = document.querySelector("video");
      const jsonDisplay = document.getElementById("json-response");
      let deviceId;
      async function startVideo() {
        const media = await navigator.mediaDevices.getUserMedia({
          video: {
            width: 512,
            height: 512,
            deviceId,
          },
        });
        video.srcObject = media;
      }
      async function stopVideo() {
        const media = video.srcObject;
        if (media) {
          media.getTracks().forEach((track) => track.stop());
        }
      }
      async function read() {
        var barcodeDetector = new BarcodeDetector({
          formats: ["ean_13"],
        });
        async function read_frame() {
          try {
            const results = await barcodeDetector.detect(video);
            if (results.length) {
              console.log(results);
              for (const r of results) {
                if (r.rawValue == null || r.rawValue == "") {
                  continue;
                } 
                const productCode = r.rawValue;
                const url = `https://world.openfoodfacts.org/api/v3/product/${productCode}.json`;
                $.getJSON(url, function(data) {
                    const allergens = data.product.allergens_from_ingredients;
                    alert(allergens);
                    // Display the full JSON response in the div
                    jsonDisplay.textContent = JSON.stringify(data, null, 2);
                }).fail(function(jqxhr, textStatus, error) {
                    console.error("Request Failed: " + textStatus + ", " + error);
                    jsonDisplay.textContent = "Error fetching data: " + error;
                });
              }
            }
          } catch (e) {
            console.error(e);
            jsonDisplay.textContent = "Error: " + e.message;
          }
          requestAnimationFrame(read_frame);
        }
        read_frame();
      }
      async function listDevices() {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const select = document.querySelector("#device-list");
        for (const device of devices) {
          if (device.kind !== "videoinput") continue;
          const option = document.createElement("option");
          option.innerText = device.label || `Video device ${device.deviceId}`;
          option.value = device.deviceId;
          select.appendChild(option);
        }
        select.onchange = async (e) => {
          deviceId = e.target.value;
          await stopVideo();
          await startVideo();
        };
      }
      async function main() {
        await startVideo();
        if (window.BarcodeDetector) {
          read().catch((e) => alert(e));
        } else {
          alert("This browser does not support native barcode scanning");
        }
        await listDevices();
      }
      main();
      window.onerror = (message) => alert(message);
    </script>
  </body>
</html>