<html>
  <head>
    <meta charset="utf-8" />
    <title>Native QR Code reader demo</title>
    <style>
      /* Previous styles remain the same */
      .response-container {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
      }
      .json-response {
        flex: 1;
        min-width: 300px;
        max-width: 500px;
        min-height: 200px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-family: monospace;
        white-space: pre-wrap;
        margin-top: 20px;
        background-color: #f5f5f5;
      }
      #console-log {
        width: 100%;
        max-width: 100%;
        min-height: 150px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-family: monospace;
        white-space: pre-wrap;
        margin-top: 20px;
        background-color: #2b2b2b;
        color: #fff;
      }
      .log-error { color: #ff6b6b; }
      .log-info { color: #69db7c; }
      .log-debug { color: #74c0fc; }
    </style>
  </head>
  <body>
    <video autoplay></video>
    <p>
      <label>camera: <select id="device-list"></select></label>
    </p>
    <div class="response-container">
      <div id="food-facts-response" class="json-response">Waiting for barcode scan...</div>
      <div id="coop-response" class="json-response">Waiting for barcode scan...</div>
    </div>
    <div id="console-log"></div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      // Console setup code remains the same
      const video = document.querySelector("video");
      const foodFactsDisplay = document.getElementById("food-facts-response");
      const coopDisplay = document.getElementById("coop-response");
      const consoleDisplay = document.getElementById("console-log");
      let deviceId;
      let lastScannedCode = null;
      let isProcessing = false;

      // Console override functions remain the same
      function formatDate() {
        return new Date().toLocaleTimeString();
      }

      function appendToConsole(message, type = 'log') {
        const timestamp = formatDate();
        let formattedMessage = `[${timestamp}] ${message}\n`;
        
        const div = document.createElement('div');
        div.textContent = formattedMessage;
        
        if (type === 'error') {
          div.className = 'log-error';
        } else if (type === 'info') {
          div.className = 'log-info';
        } else if (type === 'debug') {
          div.className = 'log-debug';
        }
        
        consoleDisplay.appendChild(div);
        consoleDisplay.scrollTop = consoleDisplay.scrollHeight;
      }

      const originalConsole = {
        log: console.log,
        error: console.error,
        info: console.info,
        debug: console.debug
      };

      console.log = function(...args) {
        originalConsole.log.apply(console, args);
        appendToConsole(args.map(arg => 
          typeof arg === 'object' ? JSON.stringify(arg) : arg
        ).join(' '));
      };

      console.error = function(...args) {
        originalConsole.error.apply(console, args);
        appendToConsole(args.map(arg => 
          typeof arg === 'object' ? JSON.stringify(arg) : arg
        ).join(' '), 'error');
      };

      console.info = function(...args) {
        originalConsole.info.apply(console, args);
        appendToConsole(args.map(arg => 
          typeof arg === 'object' ? JSON.stringify(arg) : arg
        ).join(' '), 'info');
      };

      console.debug = function(...args) {
        originalConsole.debug.apply(console, args);
        appendToConsole(args.map(arg => 
          typeof arg === 'object' ? JSON.stringify(arg) : arg
        ).join(' '), 'debug');
      };

      async function fetchOpenFoodFacts(productCode) {
        console.debug('Fetching Open Food Facts data...');
        const url = `https://world.openfoodfacts.org/api/v3/product/${productCode}.json`;
        console.debug('Open Food Facts URL:', url);
        
        try {
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error(`Open Food Facts API responded with status: ${response.status}`);
          }
          const data = await response.json();
          console.debug('Open Food Facts response received:', data);
          return data;
        } catch (error) {
          console.error('Open Food Facts API Error:', error);
          throw error;
        }
      }

      async function fetchCoopData(productCode) {
        console.debug('Fetching COOP data...');
        const url = 'https://external.api.coop.se/personalization/search/entities/by-id';
        const params = {
          'api-version': 'v1',
          'store': '251300'
        };

        const queryString = new URLSearchParams(params).toString();
        const fullUrl = `${url}?${queryString}`;
        console.debug('COOP API URL:', fullUrl);
        console.debug('COOP API Request Body:', JSON.stringify([productCode]));

        try {
          const response = await fetch(fullUrl, {
            method: 'POST',
            headers: {
              'Ocp-Apim-Subscription-Key': '3becf0ce306f41a1ae94077c16798187',
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify([productCode]),
            mode: 'cors'  // Explicitly set CORS mode
          });

          console.debug('COOP API Response status:', response.status);
          console.debug('COOP API Response headers:', [...response.headers.entries()]);

          if (!response.ok) {
            throw new Error(`COOP API responded with status: ${response.status}`);
          }

          const data = await response.json();
          console.debug('COOP API response received:', data);
          return data;
        } catch (error) {
          console.error('COOP API Error:', error);
          throw error;
        }
      }

      async function processBarcode(productCode) {
        if (isProcessing || productCode === lastScannedCode) {
          console.debug('Skipping duplicate scan or processing in progress');
          return;
        }

        console.info(`Processing new barcode: ${productCode}`);
        isProcessing = true;
        lastScannedCode = productCode;

        try {
          // First try Open Food Facts
          foodFactsDisplay.textContent = "Loading Open Food Facts data...";
          const foodFactsResponse = await fetchOpenFoodFacts(productCode);
          
          const allergens = foodFactsResponse.product?.allergens_from_ingredients;
          if (allergens) {
            console.info(`Allergens found: ${allergens}`);
            alert(`Allergens: ${allergens}`);
          }
          foodFactsDisplay.textContent = "Open Food Facts Response:\n" + 
                                       JSON.stringify(foodFactsResponse, null, 2);

          // Then try COOP
          coopDisplay.textContent = "Loading COOP data...";
          const coopResponse = await fetchCoopData(productCode);
          coopDisplay.textContent = "COOP Response:\n" + 
                                  JSON.stringify(coopResponse, null, 2);

        } catch (error) {
          // Log the error to console
          console.error("API Error:", error);
          
          // Just show "Error fetching data" in both displays
          foodFactsDisplay.textContent = "Error fetching data. Check console for details.";
          coopDisplay.textContent = "Error fetching data. Check console for details.";
        } finally {
          isProcessing = false;
          setTimeout(() => {
            lastScannedCode = null;
            console.log('Ready for next barcode scan');
          }, 5000);
        }
      }

      // Rest of the code remains exactly the same

    </script>
  </body>
</html>